@page "/bookborrowing"
@using CPRG211FinalProject.Classes

<div class="container-fluid py-4">
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-light">
            <h4 class="mb-0">Borrow Book</h4>
        </div>
        <div class="card-body">
            <div class="row g-3 align-items-end mb-4">
                <div class="col-md-4">
                    <label class="form-label">Customer ID:</label>
                    <div class="input-group">
                        <input class="form-control" type="text" placeholder="Enter customer ID" @bind="customerID" />
                        <button class="btn btn-primary" type="button" @onclick="SearchCustomer">
                            <i class="bi bi-search me-1"></i> Find Customer
                        </button>
                    </div>
                </div>
            </div>

            <h5 class="mb-3">Choose a Book to Borrow</h5>
            @if (bookList.Count == 0)
            {
                <div class="alert alert-info">Loading books...</div>
            }
            else
            {
                <div class="mb-4">
                    <select class="form-select" @bind="selectedBookID">
                        <option value="" selected disabled>Please select a book...</option>
                        @foreach (Book book in bookList)
                        {
                            <option value="@book.BookId">@DatabaseManager.GetBook(book.BookId).Title</option>
                        }
                    </select>
                    @if (!String.IsNullOrEmpty(selectedBookID))
                    {
                        OnChange();
                    }
                </div>
            }

            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Borrowing Details</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Customer ID</label>
                            <input type="text" class="form-control" placeholder="Customer ID" @bind="customerID" readonly>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Customer Name</label>
                            <input type="text" class="form-control" placeholder="Customer Name" @bind="customerName" readonly>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Book ID</label>
                            <input type="text" class="form-control" placeholder="Book ID" @bind="selectedBookID" readonly>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Author</label>
                            <input type="text" class="form-control" placeholder="Author Name" @bind="author" readonly>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Genre</label>
                            <input type="text" class="form-control" placeholder="Genre" @bind="genre" readonly>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Available Quantity</label>
                            <input type="text" class="form-control" placeholder="Available Quantity" @bind="availableQuantity" readonly>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Quantity to Borrow</label>
                            <input type="text" class="form-control" placeholder="Borrow Quantity" @bind="borrowQuantity">
                        </div>
                        <div class="col-12 mt-3">
                            <button class="btn btn-primary" type="button" @onclick="Borrow">
                                <i class="bi bi-book me-1"></i> Borrow Book
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    // Intialize variables to be used
    [Inject] NavigationManager NavigationManager { get; set; }
    string customerID = "";
    string customerName;
    string selectedBookID;
    string author;
    string genre;
    int availableQuantity;
    string borrowQuantity;

    public Book borrowBook;
    List<Book> bookList = BookManager.Books; // get the list of books to display to the user so they can borrow
    BorrowBooks bookForBorrowing = new BorrowBooks();
    Customer borrowCustomer;

    /// <summary>
    /// Instantiating the book to access its attributes
    /// </summary>
    private void OnChange()
    {
        borrowBook = DatabaseManager.GetBook(selectedBookID);
        author = borrowBook.Author;
        genre = borrowBook.Genre;
        availableQuantity = borrowBook.Quantity;
    }

    private int CheckQuantity()
    {
        int intQuantity;
        if (Int32.TryParse(borrowQuantity, out intQuantity))
        {
            if (intQuantity >= 0)
            {
                if (intQuantity > availableQuantity)
                {
                    throw new Exception($"Quantity must be less than or equal to available book count of {availableQuantity}");
                } else
                {
                    return intQuantity;
                }
            }
            else
            {
                throw new Exception("Quantity must be a positive integer");
            }
        }
        else
        {
            throw new Exception("Quantity must be a whole number");
        }

    }

    /// <summary>
    /// Checking the input for the customer id and bookID before calling the method of the button
    /// </summary>
    /// <exception cref="Exception"></exception>
    private void CheckID()
    {
        if (String.IsNullOrEmpty(customerID))
        {
            throw new Exception("Enter Customer ID first!!");
        }
        else if (String.IsNullOrEmpty(selectedBookID))
        {
            throw new Exception("Choose A Book First!!");
        }
    }

    private async Task Borrow()
    {
        try
        {
            CheckID();
            BorrowManager.AddBorrow(customerID, selectedBookID, CheckQuantity());
            customerID = null;
            customerName = null;
            selectedBookID = null;
            author = null;
            genre = null;
            availableQuantity = 0;
            borrowQuantity = null;

            await App.Current.MainPage.DisplayAlert($"Success", $"Book has been borrowed", "OK");
            NavigationManager.NavigateTo("/");
        }
        catch (Exception ex)
        {
            await App.Current.MainPage.DisplayAlert($"Error", $"{ex.Message}", "OK");
        }
    }

    private async Task SearchCustomer()
    {
        borrowCustomer = null;
        borrowCustomer = DatabaseManager.GetCustomer(customerID);
        if (String.IsNullOrEmpty(borrowCustomer.CustomerID))
        {
            await App.Current.MainPage.DisplayAlert($"Important", $"Customer Id does not Exist", "OK");
        } else // customer exists
        {
            customerID = borrowCustomer.CustomerID;
            customerName = borrowCustomer.FirstName + " " + borrowCustomer.LastName;
        }
    }


}
